var PreviewPlayerConstants={STATE_DISCONNECTED:0,STATE_CONNECTED:1,STATE_READY:2,USER_OPT_IN:"in",USER_OPT_OUT:"out",USE_H5_PREVIEW_PREFERENCE_KEY:"useH5Preview"};var PreviewPlayerEvent={ANIMATION_INCOMPATIBLE:"PreviewPlayerEvent.ANIMATION_INCOMPATIBLE",USER_OPT_IN:"PreviewPlayerEvent.USER_OPT_IN",USER_OPT_OUT:"PreviewPlayerEvent.USER_OPT_OUT"};var FPS=24,AUDIO_CHUNK_SIZE=240*1024,MAX_CONCURRENT_XHR_CONNECTION=6;function decodeMessageData(c){if(window.TextDecoder){return(new TextDecoder("utf-8").decode(c))}var a="";var e=new Uint8Array(c);var d=e.length;for(var b=0;b<d;b++){a+=String.fromCharCode(e[b])}return a}var PreviewPlayer=function(c,a,d){var b=this;this.host=c;this._encryptedMovieId=a;this._connection=null;this._connectionId=null;this._directTransferConnection=null;this._pendingAudioToken=null;this._pendingPreviewMessage=null;this._userAuthenticationToken=null;this._fromPptConversion=false;this._shouldOptInAtBeginning=d;this._connectionState=PreviewPlayerConstants.STATE_DISCONNECTED;this._mediaController=new MediaController();this._startingPreview=false;this._autoplay=false;this._mediaController.previewFragmentAddedHandler=function(){function e(){var g=b._videoElem.buffered.end(0);if((g>(b._startFrame/FPS))&&(b._startingPreview===true)){b._videoElem.currentTime=b._startFrame/FPS;b._startingPreview=false;if(b._autoplay){b._videoElem.play()}else{var h=$(".video-player-viewport").data("h5VideoControl");if(h){h.reset()}}}}try{e()}catch(f){b._videoElem.addEventListener("loadedmetadata",e)}};this._objectURL=null;this._visualScenes=null;this._audioScenes=null;this._startFrame=null};PreviewPlayer.prototype.setVideoElement=function(a){this._videoElem=a;this._updateVideoSource()};PreviewPlayer.prototype.setUserAuthenticationToken=function(a){this._userAuthenticationToken=a};PreviewPlayer.prototype.setFromPptConversion=function(a){this._fromPptConversion=a};PreviewPlayer.prototype.connect=function(){this._connection=new WebSocket(this.host);this._connection.onerror=this._connectionErrorHandler.bind(this);this._connection.onclose=this._connectionCloseHandler.bind(this);this._connection.onopen=this._connectionOpenHandler.bind(this);this._connection.onmessage=this._connectionMessageHandler.bind(this)};PreviewPlayer.prototype.send=function(a){if(this._connection){if(this._connectionState===PreviewPlayerConstants.STATE_DISCONNECTED){throw"WebSocket disconnected"}this._connection.send(a)}};PreviewPlayer.prototype.authenticate=function(){var a=JSON.stringify({eventName:"AUTH",data:this._userAuthenticationToken});this.send(a)};PreviewPlayer.prototype.preview=function(e,a,d,b){var c=JSON.stringify({eventName:"PREVIEW_BY_MOVIE_ID",data:{id:this._encryptedMovieId,ts:e,autosave:b,fromPptConversion:this._fromPptConversion}});this._autoplay=!!d;this._startingPreview=true;this._startFrame=a;this._visualFragQueue=[];this._audioFragQueue=[];this._nextFragQueue=this._audioFragQueue;this._activeXhr=0;this._receivedVisualData={};this._receivedAudioData={};if(this._connectionState===PreviewPlayerConstants.STATE_READY){this.send(c)}else{this._pendingPreviewMessage=c;this.connect()}};PreviewPlayer.prototype._handlePendingPreviewRequest=function(){if(this._pendingPreviewMessage!==null){this.send(this._pendingPreviewMessage);this._pendingPreviewMessage=null}};PreviewPlayer.prototype._updateVideoSource=function(){if(this._videoElem&&this._objectURL&&(this._videoElem.src!==this._objectURL)){this._videoElem.src=this._objectURL}};PreviewPlayer.prototype._disconnect=function(){this._connection=null;this._connectionState=PreviewPlayerConstants.STATE_DISCONNECTED};PreviewPlayer.prototype.userOptIn=function(){var b=JSON.stringify({eventName:"AUTH",data:this._userAuthenticationToken,opt:PreviewPlayerConstants.USER_OPT_IN});try{this.send(b)}catch(a){this._handleUserOptIn()}};PreviewPlayer.prototype.userOptOut=function(){var b=JSON.stringify({eventName:"AUTH",data:this._userAuthenticationToken,opt:PreviewPlayerConstants.USER_OPT_OUT});try{this.send(b)}catch(a){this._handleUserOptOut()}};PreviewPlayer.prototype._connectionOpenHandler=function(){};PreviewPlayer.prototype._connectionErrorHandler=function(a){this._disconnect()};PreviewPlayer.prototype._connectionCloseHandler=function(a){this._disconnect()};PreviewPlayer.prototype._connectionMessageHandler=function(e){var d;try{if(e.data instanceof ArrayBuffer){var g=5,f=new Uint8Array(e.data,0,g);if(f[0]===66){var c=f[1]+(f[2]<<8)+(f[3]<<16)+(f[4]<<24);var a=e.data.slice(g,c+g);d=JSON.parse(decodeMessageData(a));var h=d.bufferSize;d.buffer=e.data.slice(g+c,g+c+h)}else{throw new Error("Unexpected RSS message")}}else{d=JSON.parse(e.data)}}catch(b){console.error(b);return}switch(d.eventName){case"CONNECT_ACK":this._handleConnectAck(d);break;case"AUTH_ACK":this._handleAuthAck(d);break;case"PREVIEW_ACK":this._handlePreviewAck(d);break;case"PREVIEW_NCK":this._handlePreviewNck(d);break;case"AUDIO_READY":this._handleAudioReady(d);break;case"VISUAL_READY":this._handleVisualReady(d);break;case"AUDIO_DATA_READY":this._handleAudioDataReady(d);break;case"VISUAL_DATA_READY":this._handleVisualDataReady(d);break;case"USER_OPT_IN":this._handleUserOptIn(d);break;case"USER_OPT_OUT":this._handleUserOptOut(d);break}};PreviewPlayer.prototype._handleConnectAck=function(a){this._connectionId=a.connectionId;this._connectionState=PreviewPlayerConstants.STATE_CONNECTED;this.authenticate()};PreviewPlayer.prototype._handleAuthAck=function(b){this._connectionState=PreviewPlayerConstants.STATE_READY;var a=b.directTransferChannel;if(a){this._directTransferConnection=new WebSocket(this.host+"/"+a);this._directTransferConnection.binaryType="arraybuffer";this._directTransferConnection.onmessage=this._connectionMessageHandler.bind(this)}this._handlePendingPreviewRequest()};PreviewPlayer.prototype._handlePreviewAck=function(h){var d=this,e=h.data;this._visualScenes=e.visual;this._audioScenes=e.audio;var b=this._getSubFragmentCount(this._visualScenes),a=this._getSubFragmentCount(this._audioScenes),c=this._getAudioOffsetList(this._audioScenes),g=(a>0)?true:false,f=true;if(!window.MediaSource){return}this._objectURL=this._mediaController.initPreview(b,a,c,e.duration,function(){for(var s in d._visualScenes){if(!d._visualScenes.hasOwnProperty(s)){continue}var k=d._visualScenes[s].frags,q=d._visualScenes[s].offset;for(var m in k){var o=k[m].url,t=parseInt(m)+q;if(o){d._fetchVideo(o,t/FPS,f)}}}if(g){for(var n in d._audioScenes){if(!d._audioScenes.hasOwnProperty(n)){continue}var i=d._audioScenes[n].frags;for(var m in i){var r=i[m].url,l=i[m].length,p=i[m].size,t=parseInt(m),j=false;if(isNaN(t)){t=0;l=e.duration;j=true}if(r){d._fetchAudio(r,null,t,l/FPS,p,f,j)}}}}d._checkAndFetchFragments()});this._updateVideoSource()};PreviewPlayer.prototype._handlePreviewNck=function(a){this._triggerEvent(PreviewPlayerEvent.ANIMATION_INCOMPATIBLE)};PreviewPlayer.prototype._handleAudioReady=function(f){var h=this._audioScenes[f.token],d=f.startFrame,c=f.token,g=f.url,b=f.size,e=f.length/FPS,a=false;if(f.full){d=0;a=true}this._fetchAudio(g,c,d,e,b,false,a)};PreviewPlayer.prototype._handleVisualReady=function(d){var c=d.token,b=d.startFrame,a=c+"-"+b,g=this._visualScenes[c],f=(g.offset+b)/FPS;var e=d.url;this._fetchVideo(e,f,false,a)};PreviewPlayer.prototype._handleVisualDataReady=function(e){var d=e.token,c=e.startFrame,a=e.buffer,f=this._visualScenes[d].offset,b=d+"-"+c;if(this._receivedVisualData[b]){return}this._receivedVisualData[b]=true;var g=(f+c)/FPS;this._mediaController.addVideoFragment(a,g)};PreviewPlayer.prototype._handleAudioDataReady=function(c){var i=c.full,h=c.startFrame,a=c.length,b=c.bufferSize,g=c.buffer,d=c.token,j=c.index,l=(i===true),f=(l?0:(h/FPS)),e=a/FPS,k;if(l){k=d+"-"+j;var m=Math.ceil(b/AUDIO_CHUNK_SIZE);this._mediaController.updateRecordForAudioRangeDownload(m)}else{k=d+"-"+h}if(this._receivedAudioData[k]){return}this._receivedAudioData[k]=true;this._mediaController.addAudioFragment(g,f,e,l)};PreviewPlayer.prototype._handleUserOptIn=function(b){try{window.localStorage.setItem(PreviewPlayerConstants.USE_H5_PREVIEW_PREFERENCE_KEY,PreviewPlayerConstants.USER_OPT_IN)}catch(a){}this._triggerEvent(PreviewPlayerEvent.USER_OPT_IN)};PreviewPlayer.prototype._handleUserOptOut=function(b){try{window.localStorage.setItem(PreviewPlayerConstants.USE_H5_PREVIEW_PREFERENCE_KEY,PreviewPlayerConstants.USER_OPT_OUT)}catch(a){}this._triggerEvent(PreviewPlayerEvent.USER_OPT_OUT)};PreviewPlayer.prototype._triggerEvent=function(a){$(document).trigger(a)};PreviewPlayer.prototype._fetchVideo=function(b,f,d,c){if(c&&this._receivedVisualData[c]){return}var a=this;var e=new XMLHttpRequest();d=d||false;e.open("get",b);e.responseType="arraybuffer";e.onload=function(){a._activeXhr--;a._checkAndFetchFragments();if(c&&a._receivedVisualData[c]){return}else{if(c){a._receivedVisualData[c]=true}}a._mediaController.addVideoFragment(e.response,f)};this._visualFragQueue.push(e);if(!d){this._checkAndFetchFragments()}};PreviewPlayer.prototype._fetchAudio=function(b,g,j,d,m,c,e){c=c||false;if(e){var h,k,a,f,l=Math.ceil(m/AUDIO_CHUNK_SIZE);this._mediaController.updateRecordForAudioRangeDownload(l);for(h=0;h<l;h++){k=g+"-"+h;if(this._receivedAudioData[k]){continue}a=h*AUDIO_CHUNK_SIZE;f=((h+1)*AUDIO_CHUNK_SIZE)-1;f=Math.min(f,m);this._fetchAudioByRange(h,b,a,f,c)}}else{var k=g+"-"+j;if(this._receivedAudioData[k]){return}this._fetchAudioByFragment(b,j,d,c,e,k)}};PreviewPlayer.prototype._fetchAudioByFragment=function(a,f,c,b,d,g){var i=this,e=f/FPS,h=new XMLHttpRequest();h.open("get",a);h.responseType="arraybuffer";h.onload=function(){i._activeXhr--;i._checkAndFetchFragments();if(g&&i._receivedAudioData[g]){return}else{if(g){i._receivedAudioData[g]=true}}i._mediaController.addAudioFragment(h.response,e,c,d)};this._audioFragQueue.push(h);if(!b){this._checkAndFetchFragments()}};PreviewPlayer.prototype._fetchAudioByRange=function(a,c,h,f,e,d){var b=this,g=new XMLHttpRequest();g.open("get",c);g.setRequestHeader("range","bytes="+h+"-"+f);g.responseType="arraybuffer";g.onload=function(){b._activeXhr--;b._checkAndFetchFragments();if(d&&b._receivedAudioData[d]){return}else{if(d){b._receivedAudioData[d]=true}}b._mediaController.addAudioByRange(g.response,a)};this._audioFragQueue.push(g);if(!e){this._checkAndFetchFragments()}};PreviewPlayer.prototype._checkAndFetchFragments=function(){if(this._activeXhr<MAX_CONCURRENT_XHR_CONNECTION){if(this._nextFragQueue.length>0){var a=this._nextFragQueue.shift();this._activeXhr++;a.send()}this._nextFragQueue=(this._nextFragQueue===this._audioFragQueue)?this._visualFragQueue:this._audioFragQueue;if((this._audioFragQueue.length>0)||(this._visualFragQueue.length>0)){this._checkAndFetchFragments()}}};PreviewPlayer.prototype._getSubFragmentCount=function(a){if(!a){return 0}var c=0;for(var b in a){if(!a.hasOwnProperty(b)){continue}c+=Object.keys(a[b].frags).length}return c};PreviewPlayer.prototype._getAudioOffsetList=function(a){if(!a){return[]}for(var b in a){if(!a.hasOwnProperty(b)){continue}return Object.keys(a[b].frags).map(function(c){var d=parseInt(c);return isNaN(d)?0:(d/FPS)})}};function checkBrowser(){return window.WebSocket&&window.MediaSource}function checkTheme(a){if(a===undefined){return true}var c=a.length,d={common:true,infographics:true,business:true,whiteboard:true,commoncraft:true};for(var b=0;b<c;b++){if(d[a[b]]===undefined){return false}}return true}function checkPreviewServer(){return previewPlayer._connectionState===PreviewPlayerConstants.STATE_READY}function loadH5Preview(c,b,a){previewPlayer.preview(c,0,b,a)}var flashPlayerApi=function(d){var c;function a(){c="go"+(""+Math.random()).slice(3,15);$[c]=function(h,g){var i=$.Event(h);setTimeout(function(){d.trigger(i,g)},1)};var f=$(".video-info");b.bind("pause end reset",function(g){f.show()}).bind("play",function(){f.hide()}).bind("ready",function(){b.ready=true;f.show()})}var e=d.data("playerApi");var b=e||{ready:false,paused:false,playing:false,bind:function(g,f){d.bind(g,f);return b},one:function(g,f){d.one(g,f);return b},unbind:function(g,f){d.unbind(g,f);return b},trigger:function(g,f){d.trigger(g,[b,f]);return b},reset:function(){b.paused=false;b.playing=false;b.ready=false;return b.trigger("reset")},bindPlayerEvents:function(){var f="jQuery."+c,g=b.getPlayer();g.bind("ready",f);g.bind("play",f);g.bind("pause",f);g.bind("end",f);g.bind("scene",f);return b},unbindPlayerEvents:function(){var f="jQuery."+c,g=b.getPlayer();g.unbind("ready",f);g.unbind("play",f);g.unbind("pause",f);g.unbind("end",f);g.unbind("scene",f);return b},getPlayer:function(){return $("object",d)[0]},getScenesInfo:function(){return b.getPlayer().getSceneInfoArray()},getSceneGuid:function(){return b.getPlayer().getSceneGuid()},seek:function(f){return b.getPlayer().seek(f)},seekScene:function(f){return b.getPlayer().seekScene(f)},pause:function(){return b.getPlayer().pause()}};if(!d.data("playerApi")){a()}d.data("playerApi",b);return b};function flashPlayerLoaded(){playerApiReady=true;$(document).trigger("playerApiReady")}function loadFlashPlayer(){playerApiReady=false;$("#flash-player").flash({id:"Player",swf:flashPlayerUrl,height:"100%",width:"100%",bgcolor:"#000000",scale:"exactfit",allowScriptAccess:"always",allowFullScreen:"true",wmode:"opaque",hasVersion:"10.3",flashvars:flashPlayerVars});var a=$(".video-player-viewport").data("h5VideoControl");a.hideLoading()}function switchToFlashPlayer(){if(!$(".video-player-viewport").hasClass("using-flash")){loadFlashPlayer();$(".video-player-viewport").addClass("using-flash");$(".player-container > .notification").addClass("hidden").filter(".using-flash").removeClass("hidden");$(".shortcut-instruction, #h5-player").addClass("hidden");$("#flash-player").removeClass("hidden");$(".video-player-viewport").data("h5VideoControl").reset()}}function switchToH5Player(a){if($(".video-player-viewport").hasClass("using-flash")){if(!a&&previewPlayer){loadH5Preview()}$(".video-player-viewport").removeClass("using-flash");$(".player-container > .notification").addClass("hidden").filter(".using-h5").removeClass("hidden");$(".shortcut-instruction").removeClass("hidden");$("#flash-player").addClass("hidden")}}$(document).on(PreviewPlayerEvent.ANIMATION_INCOMPATIBLE,function(){switchToFlashPlayer();$(".player-container > .notification").addClass("hidden").filter(".incompatible").removeClass("hidden")}).on(PreviewPlayerEvent.USER_OPT_OUT,switchToFlashPlayer).on(PreviewPlayerEvent.USER_OPT_IN,switchToH5Player);
